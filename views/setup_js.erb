<script>
var debug = true;
var log = function(x) {if(debug) console.log(x);}

$('a.dropdown-toggle.notification').on('click', function (event) {
    $(this).parent().toggleClass('open');
});

$('body').on('click', function (e) {
    if (!$('li.dropdown.notification').is(e.target)
        && $('li.dropdown.notification').has(e.target).length === 0
        && $('.open').has(e.target).length === 0
    ) {
        $('li.dropdown.notification').removeClass('open');
    }
});

$("a.retweet").click(function() {
    log("click-retweet");
    var tweet_id = $(this)[0].attributes["tweet-id"].value;
    var tweet_content = $("#tweet_content_" + tweet_id)[0].innerText;
    var sender_name = $("#tweet_sender_name_" + tweet_id)[0].innerText;
    var tweet_content = tweet_content.substring(0,20) + (tweet_content.length > 20 ? "..." : "");
    var text = tweet_content + " from " + sender_name;
    retweet(tweet_id, function(status){
        if (status)
            notify("success", "retweet success", text);
        else
            notify("error", "retweet failed", text);
    });
});

function retweet(tweet_id, callback) {
    var url = '/retweet/' + tweet_id
    $.post(url, function() {
        log("retweet: success");
        callback(true);
    }).fail(function() {
        callback(false);
    });
}

function setFollowRelation(element, follow) {
    element.disabled = true;
    element.innerHTML = "<span class='glyphicon glyphicon-refresh glyphicon-refresh-animate'></span>";
    var action = follow ? "follow" : "unfollow";
    var url = window.location.href + '/' + action;
    $.post(url, function() {
        log("setFollowRelation: success");
        element.innerHTML = follow ? "Unfollow" : "Follow";
    }).always(function() {
        element.disabled = false;
    });
}

$("#follow_button").click(function() {
    console.log("click-follow/unfollow");
    setFollowRelation($(this)[0], $(this)[0].innerHTML=="Follow");
});

var Notification = (function() {

    function updateNotificationList(notifications) {
        $("#notification_badge")[0].innerHTML = notifications.length;
    }

    function getUnreadNotification() {
        $("#notification_badge")[0].innerHTML = "...";
        var url = window.location.href + '/notifications';
        $.get(url, function(data) {
            updateNotificationList(data);
        }).always(function() {
            console.log("end");
        });
    }

    function clearNotification(id) {

    }

}());
</script>
